{% extends "base.html" %}
{% load static %}

{% block title %}ðŸ“‚ WazirX Market Data{% endblock %}

{% block content %}
    
    <div class="back-button">
        <a href="{% url 'main_dashboard' %}">&larr; Back to Main Dashboard</a>
    </div>

    <h1>ðŸ“‚ WazirX 24h Market Data</h1>

    {% if warning %}
        <p style="color: var(--matrix-green); text-align: center; font-weight: bold; border: 1px dashed var(--matrix-green); padding: 10px;">{{ warning }}</p>
    {% else %}
        <div class="info-box">
            <strong>Symbols Tracked:</strong> {{ total_symbols }}<br />
            <strong>Top Pair:</strong> {{ top_symbol }}<br />
            <strong>Source:</strong> {{ source }}
        </div>

        <div class="chart-container">
            <h2>ðŸ“Š High vs Low Price (Top 10)</h2>
            <div id="wazirx-chart-bar"></div>
        </div>

        <div class="chart-container">
            <h2>ðŸ“ˆ Open Price (Top 10)</h2>
            <div id="wazirx-chart-line"></div>
        </div>

        <div class="chart-container">
            <h2>ðŸ“ˆ Historical Price Chart</h2>
            <select id="symbol-select" style="padding: 10px; border-radius: 5px; background: #000; color: #00ff41; border: 1px solid #00ff41;">
                <option value="">Select a Symbol</option>
                {% for symbol in symbols %}
                    <option value="{{ symbol }}">{{ symbol }}</option>
                {% endfor %}
            </select>
            <button id="load-chart-btn" class="btn">Load Chart</button>
            <div id="historical-chart"></div>
        </div>

        <h2>ðŸ“‹ Filtered WazirX Data</h2>
        <div>
            {{ table_html|safe }}
        </div>
    {% endif %}

    <script>        const matrixLayout = {
            plot_bgcolor: 'rgba(0,0,0,0)',
            paper_bgcolor: 'rgba(0,0,0,0)',
            font: { color: '#00ff41', family: 'Share Tech Mono, monospace' },
            xaxis: { showgrid: false, color: '#00ff41' },
            yaxis: { showgrid: true, gridcolor: 'rgba(0, 255, 65, 0.2)', color: '#00ff41' },
            margin: { t: 40, b: 40, l: 60, r: 40 }
        };

        {% if graph_json_bar and graph_json_line %}
            var graphBar = JSON.parse('{{ graph_json_bar|escapejs }}');
            var graphLine = JSON.parse('{{ graph_json_line|escapejs }}');

  
            graphBar.data.forEach(trace => {
                trace.marker = {
                    color: trace.y,
                    colorscale: [[0, '#003300'], [1, '#00ff41']], 
                    line: { color: '#00ff41', width: 1 },
                    showscale: false
                };
            });
            Object.assign(graphBar.layout, matrixLayout);

            graphLine.data.forEach(trace => {
                if(trace.type === 'scatter') {
                    trace.line = { color: '#00ff41', width: 2 };
                    trace.marker = { color: '#000', size: 6, line: { color: '#00ff41', width: 2 } }; 
                }
            });
            Object.assign(graphLine.layout, matrixLayout);

            Plotly.newPlot('wazirx-chart-bar', graphBar.data, graphBar.layout);
            Plotly.newPlot('wazirx-chart-line', graphLine.data, graphLine.layout);
        {% endif %}


        document.getElementById('load-chart-btn').addEventListener('click', function() {
            let symbol = document.getElementById('symbol-select').value;
            if (!symbol) { alert('Please select a symbol.'); return; }

            const apiSymbol = symbol; 

            fetch(`/predictions/wazirx/history/${apiSymbol}/`)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    if (data.error) { alert(data.error); return; }

                    const historicalData = data.historical_data;
                    const trace = {
                        x: historicalData.map(d => d.timestamp),
                        y: historicalData.map(d => d.last_price),
                        mode: 'lines+markers',
                        type: 'scatter',
                        name: symbol,
                        line: { color: '#00ff41', width: 2 },
                        marker: { color: '#000', size: 6, line: {color: '#00ff41', width: 1} }
                    };

                    const histLayout = {
                        title: `History: ${symbol}`,
                        ...matrixLayout
                    };

                    Plotly.newPlot('historical-chart', [trace], histLayout);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while fetching historical data.');
                });
        });
    </script>
{% endblock %}